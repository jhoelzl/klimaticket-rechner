<!-- Trip Tooltip -->
<div id="tripTooltip" class="trip-tooltip"></div>

<div class="container">
    <header>
        <div class="header-top">
            <h1 id="appTitle">ğŸš† Klimaticket Calculator</h1>
            <div class="header-actions">
                <button onclick="reloadData()" id="reloadBtn" title="Refresh data" class="header-icon-btn">ğŸ”„</button>
                <button onclick="openSettingsModal()" id="settingsBtn" title="Settings" class="hidden header-icon-btn">âš™ï¸</button>
                <button onclick="handleAuthToggle()" id="profileBtn" title="Profile" class="hidden header-icon-btn">ğŸ‘¤</button>
                <button onclick="handleAuth()" id="authBtn" class="header-auth-btn">ğŸ“§ Sign in</button>
            </div>
        </div>
    </header>

    <!-- Heatmap - quick trip entry at the top -->
    <div class="card">
        <h2 id="heatmapTitle">ğŸ”¥ Trips per Day</h2>
        <p id="heatmapSubtitle" class="heatmap-subtitle">
            Click a day to quickly add a trip.
        </p>
        <div class="heatmap-nav">
            <button id="heatmapPrevBtn" class="btn-secondary heatmap-nav-btn" onclick="previousHeatmapMonth()">â† Previous</button>
            <span id="heatmapMonthTitle" class="heatmap-month-title">January 2026</span>
            <button id="heatmapNextBtn" class="btn-secondary heatmap-nav-btn" onclick="nextHeatmapMonth()">Next â†’</button>
        </div>
        <div class="heatmap-container">
            <div id="heatmapContent" class="heatmap-months"></div>
        </div>
        <div class="heatmap-legend">
            <span id="heatmapLegendLess">Less</span>
            <div class="heatmap-legend-item">
                <div class="heatmap-legend-box legend-box-empty"></div>
            </div>
            <div class="heatmap-legend-item">
                <div class="heatmap-legend-box legend-box-level-1"></div>
            </div>
            <div class="heatmap-legend-item">
                <div class="heatmap-legend-box legend-box-level-2"></div>
            </div>
            <div class="heatmap-legend-item">
                <div class="heatmap-legend-box legend-box-level-3"></div>
            </div>
            <div class="heatmap-legend-item">
                <div class="heatmap-legend-box legend-box-level-4"></div>
            </div>
            <span id="heatmapLegendMore">More</span>
        </div>
    </div>

    <!-- Statistics -->
    <div class="card">
        <h2 id="statsTitle">ğŸ“Š Overview</h2>

        <div class="stats-validity-row">
            <div class="stats-validity-column">
                <div id="validUntilLabel" class="muted-label">Valid until</div>
                <div class="value-strong" id="expiryDate">22 Jan 2026</div>
            </div>
            <div class="stats-validity-column">
                <div id="validityLabel" class="muted-label">Validity</div>
                <div class="value-strong" id="daysRemaining">-</div>
            </div>
        </div>

        <div class="stats stats-overview">
            <div class="stats-column stats-average">
                <div class="stat-box">
                    <div class="label" id="averageTripsPerMonthLabel">Average trips per month</div>
                    <div class="value" id="averageTripsPerMonth">0.0</div>
                </div>
                <div class="stat-box">
                    <div class="label" id="averageCostLabel">Average cost per trip</div>
                    <div class="value" id="averageCost">â‚¬0.00</div>
                </div>
                <div class="stat-box">
                    <div class="label" id="averageKmLabel">Average per trip</div>
                    <div class="value" id="averageKm">0 km</div>
                </div>
            </div>
            <div class="stats-column stats-total">
                <div class="stat-box">
                    <div class="label" id="tripCountLabel">Trip count</div>
                    <div class="value" id="tripCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="label" id="totalCostLabel">Total cost</div>
                    <div class="value" id="totalCost">0â‚¬</div>
                </div>
                <div class="stat-box">
                    <div class="label" id="totalKmLabel">Total distance</div>
                    <div class="value" id="totalKm">0 km</div>
                </div>
            </div>
            <div class="stat-box stat-savings">
                <div class="label" id="savingsLabel">Savings with Klimaticket</div>
                <div class="value" id="savings">0â‚¬</div>
                <div id="savingsSummary" class="savings-summary"></div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <div id="message" class="hidden message"></div>
    </div>

    <!-- Austria states overview -->
    <div class="card">
        <h2 id="statesOverviewHeading">ğŸ—ºï¸ States Overview</h2>
        <p id="statesOverviewSubtitle" class="section-subtitle">Trips per state</p>

        <div id="austriaStatesContainer" class="state-map-container">
            <div id="statesGrid" class="states-grid">
                <!-- Will be filled by JavaScript -->
            </div>
        </div>

        <div id="statesStats" class="states-stats">
            <!-- Will be filled by JavaScript -->
        </div>
    </div>

    <!-- Carbon Tracking -->
    <div class="card">
        <h2 id="carbonTrackingTitle">ğŸŒ Carbon Impact</h2>
        <p id="carbonTrackingSubtitle" class="section-subtitle section-subtitle-lg">Your environmental contribution</p>

        <div class="stats">
            <div class="stat-box stat-box-green">
                <div class="label label-muted-light" id="carbonPerTripLabel">COâ‚‚ per trip</div>
                <div class="value value-light" id="carbonPerTrip">0 kg</div>
            </div>
            <div class="stat-box stat-box-blue">
                <div class="label label-muted-light" id="totalCarbonSavingsLabel">Total COâ‚‚ saved</div>
                <div class="value value-light" id="totalCarbonSavings">0 kg</div>
            </div>
        </div>

        <div class="carbon-comparison">
            <div id="carbonComparisonLabel" class="comparison-title">Comparison</div>
            <div class="comparison-row">
                <span id="carbonPublicTransportKmLabel">Public transport km</span>
                <span id="carbonPublicTransportKmValue" class="comparison-value">0 km</span>
            </div>
            <div class="comparison-row">
                <span id="carbonVsCarLabel">vs. Car:</span>
                <span id="carbonVsCarValue" class="comparison-value">0 km</span>
            </div>
            <div class="comparison-row last">
                <span id="carbonVsPlaneLabel">vs. Flight:</span>
                <span id="carbonVsPlaneValue" class="comparison-value">0 km</span>
            </div>
        </div>

        <div id="carbonFootprintMessage" class="carbon-footprint-message"></div>
    </div>

    <!-- Achievements/Badges -->
    <div class="card">
        <h2 id="achievementsHeading">ğŸ† Achievements</h2>
        <p id="achievementsSubtitle" class="section-subtitle">Your transit achievements</p>

        <div id="achievementsGrid" class="achievements-grid">
            <!-- Will be filled by JavaScript -->
        </div>
    </div>

    <!-- Year Overview -->
    <div class="card">
        <h2 id="yearOverviewHeading">ğŸ“… Year Overview</h2>
        <p id="yearOverviewSubtitle" class="section-subtitle-muted">Trips and costs by month</p>

        <div class="year-selector">
            <button onclick="changeYear(-1)">â† {{previousYear}}</button>
            <span id="yearOverviewTitle">2026</span>
            <button onclick="changeYear(1)">{{nextYear}} â†’</button>
        </div>

        <div class="year-overview" id="yearOverview">
            <!-- Will be filled by JavaScript -->
        </div>
    </div>

        <div class="card">
            <div class="trips-header">
                <h2 id="tripsHeading" class="heading-reset">ğŸ“‹ Your Trips</h2>
                <div class="trips-actions">
                    <button id="filterNoStateBtn" class="btn-secondary filter-btn" onclick="toggleNoStateFilter()">ğŸ” Without state</button>
                    <button id="filterOutOfRangeBtn" class="btn-secondary filter-btn" onclick="toggleOutOfRangeFilter()">âš ï¸ Out of range</button>
                    <button id="filterNoDistanceBtn" class="btn-secondary filter-btn" onclick="toggleNoDistanceFilter()">ğŸ“ Without distance</button>
                </div>
            </div>
        <div class="trips-list" id="tripsList">
                <p class="empty-state">No trips added yet</p>
        </div>
    </div>

    <!-- Entry area - alternative at the bottom -->
    <div class="card">
        <h2 id="addTripHeading">ğŸ“ Add Trip</h2>

        <p class="quick-buttons-info">
            <strong id="quickButtonsTitle">âš¡ Quick Buttons:</strong>
            <span id="quickButtonsHelp">Click a button to instantly add a trip (with today's date).</span>
        </p>

        <div class="quick-buttons">
            <button class="btn-secondary" onclick="addQuickTrip(3.60, 'S-Bahn Sbg', 10)">
                ğŸš‡ S-Bahn Sbg<br>(â‚¬3.60)
            </button>
            <button class="btn-secondary" onclick="addQuickTrip(3.00, 'Obus Sbg', 5)">
                ğŸšŒ Obus Sbg<br>(â‚¬3.00)
            </button>
        </div>

        <div class="form-group">
            <label class="required-field" id="tripDateLabel" for="tripDate">Date:</label>
            <input type="date" id="tripDate" required>
        </div>

        <div class="form-group">
            <label class="required-field" id="tripRouteLabel" for="tripRoute">Route:</label>
            <input type="text" id="tripRoute" placeholder="Salzburg - Vienna" required>
        </div>

        <div class="form-group">
            <label class="required-field" id="tripStatesLabel" for="tripStates">State(s):</label>
            <select id="tripStates" multiple class="multi-select" required>
                <option value="Salzburg">Salzburg</option>
                <option value="Wien">Wien</option>
                <option value="NiederÃ¶sterreich">NiederÃ¶sterreich</option>
                <option value="OberÃ¶sterreich">OberÃ¶sterreich</option>
                <option value="Tirol">Tirol</option>
                <option value="Vorarlberg">Vorarlberg</option>
                <option value="Steiermark">Steiermark</option>
                <option value="Burgenland">Burgenland</option>
                <option value="KÃ¤rnten">KÃ¤rnten</option>
            </select>
            <p id="tripStatesHelp" class="help-text">Multi-select with Ctrl/Cmd + click</p>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="required-field" id="tripCostLabel" for="tripCost">Cost (EUR):</label>
                <input type="number" id="tripCost" placeholder="5.00" step="0.01" min="0" required>
            </div>
            <div class="form-group">
                <label id="tripDistanceLabel" for="tripDistance">Distance (km):</label>
                <input type="number" id="tripDistance" placeholder="100" step="0.1" min="0">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label id="tripNotesLabel" for="tripNotes">Notes:</label>
                <input type="text" id="tripNotes" placeholder="">
            </div>
        </div>

        <p id="tripDistanceHelp" class="help-text-inline">Approximate distance of your trip for accurate carbon calculation</p>

        <button id="saveTripBtn" class="btn-primary btn-full" onclick="addTrip()">
            â• Save trip
        </button>
    </div>

    <!-- Export/Backup -->
    <div class="card">
        <h2 id="backupHeading">ğŸ’¾ Backup</h2>
        <p class="section-subtitle-muted">
            <span id="backupSubtitle">Export your data as JSON or CSV for backup.</span>
        </p>
        <div class="export-buttons">
            <button id="exportJsonBtn" class="btn-secondary" onclick="exportJSON()">ğŸ“¥ JSON Export</button>
            <button id="exportCsvBtn" class="btn-secondary" onclick="exportCSV()">ğŸ“Š CSV Export</button>
            <button id="exportPdfBtn" class="btn-primary" onclick="exportPDF()">ğŸ“„ PDF Summary</button>
            <button id="importBtn" class="btn-secondary" onclick="importData()">ğŸ“¤ Import</button>
            <button id="deleteBtn" class="btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Delete</button>
        </div>
    </div>
</div>

<!-- Hidden input for import -->
<input type="file" id="importFile" accept=".json,.csv" class="hidden" onchange="handleFileImport()">

<!-- Auth Modal -->
<div id="authModal" class="modal">
    <div class="modal-content">
        <button type="button" class="modal-close-btn" onclick="closeAuthModal()" title="Close (ESC)">âœ•</button>
        <div class="modal-tabs">
            <button id="loginTab" class="modal-tab active" onclick="switchAuthTab('login')">ğŸ” Sign in</button>
            <button id="signupTab" class="modal-tab" onclick="switchAuthTab('signup')">âœï¸ Sign up</button>
        </div>

        <!-- Login Form -->
        <form class="modal-form active" id="loginForm" onsubmit="submitLogin(event)">
            <label class="required-field modal-label">Email</label>
            <input type="email" placeholder="your@email.com" id="loginEmail" required class="modal-input">
            <label class="required-field modal-label">Password</label>
            <input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" id="loginPassword" required>
            <div class="modal-buttons">
                <button id="loginCancelBtn" type="button" class="modal-btn-secondary" onclick="closeAuthModal()">Cancel</button>
                <button id="loginSubmitBtn" type="submit" class="modal-btn-primary">Sign in</button>
            </div>
        </form>

        <!-- Signup Form -->
        <form class="modal-form" id="signupForm" onsubmit="submitSignup(event)">
            <label class="required-field modal-label">Email</label>
            <input type="email" placeholder="your@email.com" id="signupEmail" required class="modal-input">
            <label class="required-field modal-label">Password</label>
            <input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" id="signupPassword" required minlength="6" class="modal-input">
            <small class="modal-note">Minimum 6 characters</small>
            <label class="required-field modal-label">Repeat password</label>
            <input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" id="signupPasswordConfirm" required minlength="6">
            <div class="modal-buttons">
                <button id="signupCancelBtn" type="button" class="modal-btn-secondary" onclick="closeAuthModal()">Cancel</button>
                <button id="signupSubmitBtn" type="submit" class="modal-btn-primary">Sign up</button>
            </div>
        </form>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <button type="button" class="modal-close-btn" onclick="closeSettingsModal()" title="Close (ESC)">âœ•</button>
        <h2 id="settingsTitle" class="modal-title">âš™ï¸ Settings</h2>
        <form class="settings-form" onsubmit="submitSettings(event)">
            <!-- Dark Mode Toggle -->
            <div class="theme-toggle">
                <label id="darkModeLabel" for="darkModeToggle">ğŸŒ“ Dark mode</label>
                <div class="toggle-switch" id="darkModeToggle" onclick="toggleDarkMode()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <p id="darkModeHelp" class="settings-help help-text-tight">Automatically follow system setting</p>

            <label id="languageLabel" for="languageSelect" class="field-spacing-top">Language</label>
            <select id="languageSelect" required>
                <option value="en">English</option>
                <option value="de">Deutsch</option>
            </select>
            <p id="languageHelp" class="settings-help">Choose the app language.</p>

            <label class="required-field" id="ticketCostLabel" for="ticketCostInput">Klimaticket cost (â‚¬)</label>
            <input type="number" id="ticketCostInput" placeholder="1400" min="0" step="0.01" required>
            <p id="ticketCostHelp" class="settings-help">The amount your Klimaticket costs (e.g. after employer subsidy).</p>

            <label class="required-field field-spacing-top" id="startDateLabel" for="startDateInput">Valid from (start date)</label>
            <input type="date" id="startDateInput" required>
            <p id="startDateHelp" class="settings-help">The day your Klimaticket becomes valid.</p>

            <label class="required-field field-spacing-top" id="endDateLabel" for="endDateInput">Valid until (end date)</label>
            <input type="date" id="endDateInput" required>
            <p id="endDateHelp" class="settings-help">The last day your Klimaticket is valid.</p>

            <div class="modal-buttons">
                <button id="settingsCancelBtn" type="button" class="modal-btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                <button id="settingsSaveBtn" type="submit" class="modal-btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Trip Modal -->
<div id="editTripModal" class="modal">
    <div class="modal-content">
        <button type="button" class="modal-close-btn" onclick="closeEditTripModal()" title="Close (ESC)">âœ•</button>
        <h2 id="editTripHeading" class="modal-title">âœï¸ Edit Trip</h2>
        <form class="settings-form" onsubmit="submitEditTrip(event)">
            <label class="required-field" id="editTripDateLabel" for="editTripDate">Date:</label>
            <input type="date" id="editTripDate" required>

            <label class="required-field field-spacing-top-sm" id="editTripRouteLabel" for="editTripRoute">Route:</label>
            <input type="text" id="editTripRoute" placeholder="Salzburg - Vienna" required>

            <label class="required-field field-spacing-top-sm" id="editTripStatesLabel" for="editTripStates">State(s):</label>
            <select id="editTripStates" multiple class="multi-select" required>
                <option value="Salzburg">Salzburg</option>
                <option value="Wien">Wien</option>
                <option value="NiederÃ¶sterreich">NiederÃ¶sterreich</option>
                <option value="OberÃ¶sterreich">OberÃ¶sterreich</option>
                <option value="Tirol">Tirol</option>
                <option value="Vorarlberg">Vorarlberg</option>
                <option value="Steiermark">Steiermark</option>
                <option value="Burgenland">Burgenland</option>
                <option value="KÃ¤rnten">KÃ¤rnten</option>
            </select>

            <label class="required-field field-spacing-top-sm" id="editTripCostLabel" for="editTripCost">Cost (EUR):</label>
            <input type="number" id="editTripCost" placeholder="5.00" step="0.01" min="0" required>

            <label id="editTripDistanceLabel" for="editTripDistance" class="field-spacing-top-sm">Distance (km):</label>
            <input type="number" id="editTripDistance" placeholder="45" step="0.1" min="0">

            <label id="editTripNotesLabel" for="editTripNotes" class="field-spacing-top-sm">Notes:</label>
            <input type="text" id="editTripNotes" placeholder="">

            <div class="modal-buttons">
                <button id="editTripCancelBtn" type="button" class="modal-btn-secondary" onclick="closeEditTripModal()">Cancel</button>
                <button id="editTripSaveBtn" type="submit" class="modal-btn-primary">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Quick Add Trip Modal (from Calendar) -->
<div id="quickAddModal" class="modal">
    <div class="modal-content">
        <button type="button" class="modal-close-btn" onclick="closeQuickAddModal()" title="Close (ESC)">âœ•</button>
        <h2 class="modal-title"><span id="quickAddTitle">âš¡ Add Trip</span> - <span id="quickAddDate"></span></h2>

        <div class="section-spacing-md">
            <label id="quickAddQuickButtonsLabel" class="quick-buttons-label"><strong>Quick Buttons:</strong></label>
            <div class="quick-buttons">
                <button type="button" class="btn-secondary" onclick="submitQuickAddTrip(3.60, 'S-Bahn Sbg', 10)">
                    ğŸš‡ S-Bahn Sbg<br>(â‚¬3.60)
                </button>
                <button type="button" class="btn-secondary" onclick="submitQuickAddTrip(3.00, 'Obus Sbg', 5)">
                    ğŸšŒ Obus Sbg<br>(â‚¬3.00)
                </button>
            </div>
        </div>

        <hr class="divider">

        <form class="settings-form" onsubmit="submitCustomQuickAddTrip(event)">
            <label id="quickTripRouteLabel" for="quickTripRoute">Route:</label>
            <input type="text" id="quickTripRoute" placeholder="Salzburg - Vienna">

            <label class="required-field field-spacing-top-sm" id="quickTripStatesLabel" for="quickTripStates">State(s):</label>
            <select id="quickTripStates" multiple class="multi-select" required>
                <option value="Salzburg" selected>Salzburg</option>
                <option value="Wien">Wien</option>
                <option value="NiederÃ¶sterreich">NiederÃ¶sterreich</option>
                <option value="OberÃ¶sterreich">OberÃ¶sterreich</option>
                <option value="Tirol">Tirol</option>
                <option value="Vorarlberg">Vorarlberg</option>
                <option value="Steiermark">Steiermark</option>
                <option value="Burgenland">Burgenland</option>
                <option value="KÃ¤rnten">KÃ¤rnten</option>
            </select>

            <label class="required-field field-spacing-top-sm" id="quickTripCostLabel" for="quickTripCost">Cost (EUR):</label>
            <input type="number" id="quickTripCost" placeholder="5.00" step="0.01" min="0" required>

            <label id="quickTripDistanceLabel" for="quickTripDistance" class="field-spacing-top-sm">Distance (km):</label>
            <input type="number" id="quickTripDistance" placeholder="45" step="0.1" min="0">
            <small id="quickTripDistanceHelp" class="help-text-small">Approximate distance for accurate COâ‚‚ calculation</small>

            <label id="quickTripNotesLabel" for="quickTripNotes" class="field-spacing-top-sm">Notes:</label>
            <input type="text" id="quickTripNotes" placeholder="">

            <div class="modal-buttons modal-buttons-spaced">
                <button id="quickAddCancelBtn" type="button" class="modal-btn-secondary" onclick="closeQuickAddModal()">Cancel</button>
                <button id="quickAddSubmitBtn" type="submit" class="modal-btn-primary">Add</button>
            </div>
        </form>
    </div>
</div>
