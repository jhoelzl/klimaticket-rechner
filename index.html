<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Klimaticket Rechner">
    <meta name="description" content="Verfolge Deine Klimaticket-Fahrten und berechne Deine Ersparnisse">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23087e8b' width='192' height='192'/><text x='96' y='140' font-size='100' font-weight='bold' fill='white' text-anchor='middle'>‚Ç¨</text></svg>">
    <title>Klimaticket Rechner</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #087e8b;
            --secondary: #05a8a3;
            --success: #4caf50;
            --danger: #f44336;
            --light: #f5f5f5;
            --dark: #333;
            --border: #ddd;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 24px 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .auth-status {
            font-size: 12px;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
        }

        .auth-status.online {
            background: rgba(76, 175, 80, 0.3);
        }

        .auth-status.offline {
            background: rgba(244, 67, 54, 0.3);
        }

        .auth-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .auth-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            background: rgba(255,255,255,0.9);
            color: var(--primary);
            font-weight: 600;
        }

        .auth-buttons button:active {
            opacity: 0.8;
        }

        .info-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
            font-size: 14px;
        }

        .info-box {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .info-box strong {
            display: block;
            font-size: 12px;
            opacity: 0.9;
        }

        .info-box span {
            font-size: 16px;
            font-weight: bold;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 16px;
            font-size: 18px;
            border-bottom: 2px solid var(--light);
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(8, 126, 139, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .quick-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-buttons button {
            flex: 1;
        }

        button {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
            background: #066270;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
            font-size: 13px;
        }

        .btn-secondary:active {
            background: #048a82;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            font-size: 13px;
        }

        .btn-danger:active {
            background: #da190b;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:active {
            background: #388e3c;
        }

        .trips-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .trip-item {
            background: var(--light);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .trip-item .trip-info {
            flex: 1;
        }

        .trip-date {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .trip-cost {
            font-weight: bold;
            color: var(--primary);
            font-size: 16px;
        }

        .trip-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
        }

        .stat-box .value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-savings {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--success), #66bb6a) !important;
        }

        .stat-savings .value {
            font-size: 32px;
        }

        .progress-bar {
            background: #ddd;
            height: 8px;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--success);
            height: 100%;
            transition: width 0.3s ease;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        .message.positive {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .message.negative {
            background: #ffcdd2;
            color: #c62828;
        }

        .export-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .export-buttons button {
            flex: 1;
            min-width: 120px;
            font-size: 13px;
        }

        .hidden {
            display: none;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(120px);
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-weight: 600;
            font-size: 16px;
            z-index: 9999;
            max-width: 90%;
            animation: slideUp 0.3s ease forwards;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideUp {
            to {
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes slideDown {
            to {
                transform: translateX(-50%) translateY(120px);
                opacity: 0;
            }
        }

        .toast.hide {
            animation: slideDown 0.3s ease forwards;
        }

        /* Auth Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .modal-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border);
        }

        .modal-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .modal-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .modal-form {
            display: none;
        }

        .modal-form.active {
            display: block;
        }

        .modal-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            font-family: inherit;
        }

        .modal-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(8, 126, 139, 0.1);
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn-primary {
            background: var(--primary);
            color: white;
        }

        .modal-btn-primary:active {
            opacity: 0.9;
        }

        .modal-btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .modal-btn-secondary:active {
            opacity: 0.9;
        }

        /* Settings Modal */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .settings-form label {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 4px;
        }

        .settings-form input {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .settings-form input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(8, 126, 139, 0.1);
        }

        .settings-help {
            font-size: 12px;
            color: #999;
            margin-top: -8px;
            margin-bottom: 12px;
        }

        /* Heatmap Styles */
        .heatmap-container {
            margin-top: 16px;
            overflow-x: auto;
        }

        .heatmap-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 12px;
        }

        .heatmap-months {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .heatmap-month {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            background: var(--light);
        }

        .heatmap-month-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            text-align: center;
        }

        .heatmap-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .heatmap-day-header {
            font-size: 10px;
            font-weight: 600;
            text-align: center;
            color: #999;
            padding: 4px;
        }

        .heatmap-day {
            aspect-ratio: 1;
            border-radius: 3px;
            background: #ebedf0;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .heatmap-day:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .heatmap-day.empty {
            background: #ebedf0;
            color: #ccc;
        }

        .heatmap-day.level-1 {
            background: #c6e48b;
        }

        .heatmap-day.level-2 {
            background: #7bc96f;
        }

        .heatmap-day.level-3 {
            background: #239a3b;
        }

        .heatmap-day.level-4 {
            background: #196127;
        }

        .heatmap-legend {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .heatmap-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .heatmap-legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid #ddd;
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 24px;
            }

            .info-row {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }

        @supports (padding: max(0px)) {
            body {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }

            .container {
                padding: 16px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>üöÜ Klimaticket Rechner</h1>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <button onclick="reloadData()" id="reloadBtn" title="Daten aktualisieren" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 14px;">üîÑ</button>
                    <button onclick="openSettingsModal()" id="settingsBtn" title="Einstellungen" class="hidden" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 14px;">‚öôÔ∏è</button>
                    <button onclick="handleAuthToggle()" id="profileBtn" title="Profil" class="hidden" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 14px;">üë§</button>
                    <button onclick="handleAuth()" id="authBtn" style="background: rgba(255,255,255,0.9); color: var(--primary); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">üìß Anmelden</button>
                </div>
            </div>
        </header>

        <!-- Heatmap - oben f√ºr schnelle Fahrteintr√§ge -->
        <div class="card">
            <h2>üî• Fahrten pro Tag</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
                Klick auf einen Tag, um schnell eine Fahrt hinzuzuf√ºgen.
            </p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <button class="btn-secondary" onclick="previousHeatmapMonth()" style="padding: 8px 12px; font-size: 13px;">‚Üê Vorheriger</button>
                <span id="heatmapMonthTitle" style="font-weight: 600; color: var(--dark); font-size: 14px;">Januar 2026</span>
                <button class="btn-secondary" onclick="nextHeatmapMonth()" style="padding: 8px 12px; font-size: 13px;">N√§chster ‚Üí</button>
            </div>
            <div class="heatmap-container">
                <div id="heatmapContent" class="heatmap-months"></div>
            </div>
            <div class="heatmap-legend">
                <span>Weniger</span>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-box" style="background: #ebedf0;"></div>
                </div>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-box" style="background: #c6e48b;"></div>
                </div>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-box" style="background: #7bc96f;"></div>
                </div>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-box" style="background: #239a3b;"></div>
                </div>
                <div class="heatmap-legend-item">
                    <div class="heatmap-legend-box" style="background: #196127;"></div>
                </div>
                <span>Mehr</span>
            </div>
        </div>

        <!-- Statistiken -->
        <div class="card">
            <h2>üìä √úbersicht</h2>
            
            <div style="display: flex; gap: 12px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border); font-size: 13px;">
                <div style="flex: 1;">
                    <div style="color: #999; margin-bottom: 4px;">G√ºltig bis</div>
                    <div style="font-weight: 600; color: var(--dark);" id="expiryDate">22. J√§n. 2026</div>
                </div>
                <div style="flex: 1;">
                    <div style="color: #999; margin-bottom: 4px;">G√ºltigkeit</div>
                    <div style="font-weight: 600; color: var(--dark);" id="daysRemaining">-</div>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <div class="label">Anzahl Fahrten</div>
                    <div class="value" id="tripCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Gesamtkosten (ohne Ticket)</div>
                    <div class="value" id="totalCost">0‚Ç¨</div>
                </div>
                <div class="stat-box stat-savings">
                    <div class="label" id="savingsLabel">Ersparnis mit Klimaticket</div>
                    <div class="value" id="savings">0‚Ç¨</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="message" class="hidden message"></div>
        </div>

        <!-- Austria Bundeslands Map -->
        <div class="card">
            <h2>üó∫Ô∏è Bundeslands-√úbersicht</h2>
            <p style="font-size: 13px; color: #666; margin-bottom: 12px;">Fahrten pro Bundesland (nur g√ºltige Fahrten)</p>
            
            <div id="austriaMapContainer" style="background: #f5f5f5; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                <svg id="austriaMap" viewBox="0 0 900 400" style="max-width: 100%; height: auto;">
                    <!-- Vorarlberg (ganz links, klein) -->
                    <path id="vorarlberg" d="M 20,180 L 25,165 L 35,155 L 50,150 L 60,152 L 68,160 L 72,175 L 70,190 L 62,202 L 50,208 L 38,205 L 28,195 L 22,185 Z" fill="#e8f5e9" stroke="#555" stroke-width="1" stroke-linejoin="round" style="cursor: pointer; transition: all 0.2s;">
                        <title>Vorarlberg</title>
                    </path>
                    
                    <!-- Tirol (lang gestreckt von links bis mitte) -->
                    <path id="tirol" d="M 70,190 L 80,182 L 100,175 L 130,170 L 165,168 L 200,167 L 240,168 L 280,170 L 315,175 L 340,182 L 355,192 L 360,205 L 355,220 L 342,232 L 320,240 L 290,245 L 255,246 L 220,244 L 185,240 L 150,234 L 115,225 L 85,213 L 72,200 Z" fill="#e8f5e9" stroke="#555" stroke-width="1" stroke-linejoin="round" style="cursor: pointer; transition: all 0.2s;">
                        <title>Tirol</title>
                    </path>
                    
                    <!-- Salzburg (kompakt, n√∂rdlich von K√§rnten) -->
                    <path id="salzburg" d="M 355,192 L 370,188 L 390,186 L 410,188 L 428,195 L 438,208 L 440,225 L 435,240 L 422,250 L 405,254 L 385,252 L 368,245 L 358,230 L 355,215 Z" fill="#e8f5e9" stroke="#555" stroke-width="1" stroke-linejoin="round" style="cursor: pointer; transition: all 0.2s;">
                        <title>Salzburg</title>
                    </path>
                    
                    <!-- Ober√∂sterreich (n√∂rdlich der Mitte) -->
                    <path id="ober√∂sterreich" d="M 440,160 L 465,155 L 495,152 L 525,151 L 555,153 L 580,158 L 600,167 L 612,180 L 618,195 L 615,212 L 605,228 L 588,238 L 565,243 L 540,243 L 515,240 L 490,234 L 468,225 L 448,212 L 438,195 L 438,175 Z" fill="#e8f5e9" stroke="#555" stroke-width="1" stroke-linejoin="round" style="cursor: pointer; transition: all 0.2s;">
                        <title>Ober√∂sterreich</title>
                    </path>
                    
                    <!-- Nieder√∂sterreich (gro√ü, um Wien herum) -->
                    <path id="nieder√∂sterreich" d="M 618,195 L 645,188 L 675,185 L 705,186 L 735,190 L 760,197 L 780,207 L 795,220 L 805,238 L 808,258 L 803,278 L 790,295 L 770,307 L 745,313 L 715,315 L 685,312 L 655,305 L 628,295 L 605,282 L 590,265 L 583,245 L 585,225 L 595,208 L 608,198 Z" fill="#e8f5e9" stroke="#555" stroke-width="1" stroke-linejoin="round" style="cursor: pointer; transition: all 0.2s;">
                        <title>Nieder√∂sterreich</title>
                    </path>
                    
                    <!-- Wien (kleiner Kreis in Nieder√∂sterreich) -->
                    <circle id="wien" cx="795" cy="235" r="15" fill="#e8f5e9" stroke="#555" stroke-width="1.2" style="cursor: pointer; transition: all 0.2s;">
                        <title>Wien</title>
                    </circle>
                    
                    <!-- Burgenland (schmaler Streifen rechts) -->
                    <path id="burgenland" d="M 808,258 L 820,265 L 830,278 L 837,295 L 840,315 L 837,335 L 828,352 L 815,365 L 802,370 L 792,365 L 788,348 L 790,330 L 795,310 L 800,290 L 803,275 Z" fill="#e8f5e9" stroke="#555" stroke-width="1" stroke-linejoin="round" style="cursor: pointer; transition: all 0.2s;">
                        <title>Burgenland</title>
                    </path>
                    
                    <!-- Steiermark (gro√ü, s√ºd√∂stlich) -->
                    <path id="steiermark" d="M 440,250 L 465,258 L 495,265 L 530,270 L 565,273 L 600,274 L 635,276 L 670,280 L 700,288 L 720,298 L 735,312 L 742,328 L 740,345 L 728,360 L 708,370 L 680,376 L 645,378 L 610,376 L 575,370 L 540,362 L 505,350 L 470,335 L 442,318 L 425,298 L 418,278 L 420,260 Z" fill="#e8f5e9" stroke="#555" stroke-width="1" stroke-linejoin="round" style="cursor: pointer; transition: all 0.2s;">
                        <title>Steiermark</title>
                    </path>
                    
                    <!-- K√§rnten (s√ºdlich, unter Salzburg/Tirol) -->
                    <path id="k√§rnten" d="M 320,240 L 345,248 L 375,255 L 405,260 L 435,262 L 460,260 L 480,255 L 495,247 L 505,260 L 508,278 L 502,295 L 488,308 L 465,318 L 435,323 L 405,324 L 375,320 L 345,312 L 315,300 L 290,285 L 275,268 L 268,252 L 270,240 L 285,238 Z" fill="#e8f5e9" stroke="#555" stroke-width="1" stroke-linejoin="round" style="cursor: pointer; transition: all 0.2s;">
                        <title>K√§rnten</title>
                    </path>
                    
                    <!-- Labels -->
                    <text x="45" y="185" font-size="12" font-weight="600" fill="#333" text-anchor="middle" pointer-events="none">V</text>
                    <text x="210" y="210" font-size="12" font-weight="600" fill="#333" text-anchor="middle" pointer-events="none">T</text>
                    <text x="395" y="223" font-size="12" font-weight="600" fill="#333" text-anchor="middle" pointer-events="none">S</text>
                    <text x="530" y="200" font-size="12" font-weight="600" fill="#333" text-anchor="middle" pointer-events="none">O√ñ</text>
                    <text x="705" y="248" font-size="12" font-weight="600" fill="#333" text-anchor="middle" pointer-events="none">N√ñ</text>
                    <text x="795" y="240" font-size="10" font-weight="600" fill="#333" text-anchor="middle" pointer-events="none">W</text>
                    <text x="815" y="320" font-size="12" font-weight="600" fill="#333" text-anchor="middle" pointer-events="none">B</text>
                    <text x="600" y="325" font-size="12" font-weight="600" fill="#333" text-anchor="middle" pointer-events="none">St</text>
                    <text x="405" y="290" font-size="12" font-weight="600" fill="#333" text-anchor="middle" pointer-events="none">K</text>
                    
                    <!-- Legend -->
                    <g transform="translate(30, 375)">
                        <text x="0" y="0" font-size="11" fill="#666">Weniger</text>
                        <rect x="50" y="-10" width="16" height="12" fill="#e8f5e9" stroke="#999" stroke-width="0.5" rx="2"/>
                        <rect x="70" y="-10" width="16" height="12" fill="#c8e6c9" stroke="#999" stroke-width="0.5" rx="2"/>
                        <rect x="90" y="-10" width="16" height="12" fill="#81c784" stroke="#999" stroke-width="0.5" rx="2"/>
                        <rect x="110" y="-10" width="16" height="12" fill="#4caf50" stroke="#999" stroke-width="0.5" rx="2"/>
                        <rect x="130" y="-10" width="16" height="12" fill="#2e7d32" stroke="#999" stroke-width="0.5" rx="2"/>
                        <text x="150" y="0" font-size="11" fill="#666">Mehr</text>
                    </g>
                </svg>
            </div>
            
            <div id="bundeslandsStats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px;">
                <!-- Will be filled by JavaScript -->
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h2 style="margin: 0;">üìã Deine Fahrten</h2>
                <button id="filterNoBundeslandBtn" class="btn-secondary" onclick="toggleNoBundeslandFilter()" style="font-size: 12px; padding: 6px 12px;">üîç Ohne Bundesland</button>
            </div>
            <div class="trips-list" id="tripsList">
                <p style="color: #999; text-align: center; padding: 20px;">Noch keine Fahrten hinzugef√ºgt</p>
            </div>
        </div>

        <!-- Eingabe-Bereich - unten als Alternative -->
        <div class="card">
            <h2>üìù Fahrt hinzuf√ºgen</h2>
            
            <p style="font-size: 14px; color: #666; margin-bottom: 16px;">
                <strong>‚ö° Quick Buttons:</strong> Klick einen Button, um sofort eine Fahrt hinzuzuf√ºgen (mit heutigem Datum).
            </p>
            
            <div class="quick-buttons">
                <button class="btn-secondary" onclick="addQuickTrip(3.60, 'S-Bahn Sbg')">
                    üöá S-Bahn Sbg<br>(3,60‚Ç¨)
                </button>
                <button class="btn-secondary" onclick="addQuickTrip(3.00, 'Obus Sbg')">
                    üöå Obus Sbg<br>(3,00‚Ç¨)
                </button>
            </div>

            <div class="form-group">
                <label for="tripDate">Datum:</label>
                <input type="date" id="tripDate">
            </div>

            <div class="form-group">
                <label for="tripRoute">Route (z.B. Salzburg - Wien):</label>
                <input type="text" id="tripRoute" placeholder="Von - Nach">
            </div>

            <div class="form-group">
                <label for="tripBundeslaender">Bundesland(er) betroffen:</label>
                <select id="tripBundeslaender" multiple style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                    <option value="Salzburg">Salzburg</option>
                    <option value="Wien">Wien</option>
                    <option value="Nieder√∂sterreich">Nieder√∂sterreich</option>
                    <option value="Ober√∂sterreich">Ober√∂sterreich</option>
                    <option value="Tirol">Tirol</option>
                    <option value="Vorarlberg">Vorarlberg</option>
                    <option value="Steiermark">Steiermark</option>
                    <option value="Burgenland">Burgenland</option>
                    <option value="K√§rnten">K√§rnten</option>
                </select>
                <p style="font-size: 12px; color: #999; margin-top: 4px;">Mehrfachauswahl mit Ctrl/Cmd + Klick</p>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="tripCost">Kosten ohne Ticket (EUR):</label>
                    <input type="number" id="tripCost" placeholder="5.00" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="tripNotes">Notiz:</label>
                    <input type="text" id="tripNotes" placeholder="optional">
                </div>
            </div>

            <button class="btn-primary" onclick="addTrip()" style="width: 100%;">
                ‚ûï Fahrt speichern
            </button>
        </div>

        <!-- Export/Backup -->
        <div class="card">
            <h2>üíæ Datensicherung</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 12px;">
                Exportiere Deine Daten als JSON oder CSV f√ºr Backup.
            </p>
            <div class="export-buttons">
                <button class="btn-secondary" onclick="exportJSON()">üì• JSON Export</button>
                <button class="btn-secondary" onclick="exportCSV()">üìä CSV Export</button>
                <button class="btn-secondary" onclick="importData()">üì§ Importieren</button>
                <button class="btn-danger" onclick="clearAllData()">üóëÔ∏è L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Hidden input for import -->
    <input type="file" id="importFile" accept=".json,.csv" style="display: none;" onchange="handleFileImport()">

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchAuthTab('login')">üîê Anmelden</button>
                <button class="modal-tab" onclick="switchAuthTab('signup')">‚úçÔ∏è Registrieren</button>
            </div>

            <!-- Login Form -->
            <form class="modal-form active" id="loginForm" onsubmit="submitLogin(event)">
                <input type="email" placeholder="E-Mail" id="loginEmail" required>
                <input type="password" placeholder="Passwort" id="loginPassword" required>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn-secondary" onclick="closeAuthModal()">Abbrechen</button>
                    <button type="submit" class="modal-btn-primary">Anmelden</button>
                </div>
            </form>

            <!-- Signup Form -->
            <form class="modal-form" id="signupForm" onsubmit="submitSignup(event)">
                <input type="email" placeholder="E-Mail" id="signupEmail" required>
                <input type="password" placeholder="Passwort (mind. 6 Zeichen)" id="signupPassword" required minlength="6">
                <input type="password" placeholder="Passwort wiederholen" id="signupPasswordConfirm" required minlength="6">
                <div class="modal-buttons">
                    <button type="button" class="modal-btn-secondary" onclick="closeAuthModal()">Abbrechen</button>
                    <button type="submit" class="modal-btn-primary">Registrieren</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: var(--primary);">‚öôÔ∏è Einstellungen</h2>
            <form class="settings-form" onsubmit="submitSettings(event)">
                <label for="ticketCostInput">Klimaticket Kostenbetrag (‚Ç¨)</label>
                <input type="number" id="ticketCostInput" placeholder="z.B. 1400" min="0" step="0.01" required>
                <p class="settings-help">Der Betrag, den dein Klimaticket kostet (z.B. nach Arbeitgeberzuschuss).</p>
                
                <label for="startDateInput" style="margin-top: 16px;">G√ºltig ab (Anfangsdatum)</label>
                <input type="date" id="startDateInput" required>
                <p class="settings-help">Der Tag, ab dem dein Klimaticket g√ºltig ist.</p>
                
                <label for="endDateInput" style="margin-top: 16px;">G√ºltig bis (Enddatum)</label>
                <input type="date" id="endDateInput" required>
                <p class="settings-help">Der letzte Tag, an dem dein Klimaticket g√ºltig ist.</p>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-btn-secondary" onclick="closeSettingsModal()">Abbrechen</button>
                    <button type="submit" class="modal-btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Trip Modal -->
    <div id="editTripModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: var(--primary);">‚úèÔ∏è Fahrt bearbeiten</h2>
            <form class="settings-form" onsubmit="submitEditTrip(event)">
                <label for="editTripDate">Datum:</label>
                <input type="date" id="editTripDate" required>
                
                <label for="editTripRoute" style="margin-top: 12px;">Route:</label>
                <input type="text" id="editTripRoute" placeholder="z.B. Salzburg - Wien" required>

                <label for="editTripBundeslaender" style="margin-top: 12px;">Bundesland(er):</label>
                <select id="editTripBundeslaender" multiple style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                    <option value="Salzburg">Salzburg</option>
                    <option value="Wien">Wien</option>
                    <option value="Nieder√∂sterreich">Nieder√∂sterreich</option>
                    <option value="Ober√∂sterreich">Ober√∂sterreich</option>
                    <option value="Tirol">Tirol</option>
                    <option value="Vorarlberg">Vorarlberg</option>
                    <option value="Steiermark">Steiermark</option>
                    <option value="Burgenland">Burgenland</option>
                    <option value="K√§rnten">K√§rnten</option>
                </select>
                
                <label for="editTripCost" style="margin-top: 12px;">Kosten (EUR):</label>
                <input type="number" id="editTripCost" placeholder="5.00" step="0.01" min="0" required>
                
                <label for="editTripNotes" style="margin-top: 12px;">Notiz:</label>
                <input type="text" id="editTripNotes" placeholder="optional">
                
                <div class="modal-buttons">
                    <button type="button" class="modal-btn-secondary" onclick="closeEditTripModal()">Abbrechen</button>
                    <button type="submit" class="modal-btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Add Trip Modal (from Calendar) -->
    <div id="quickAddModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; color: var(--primary);">‚ö° Fahrt hinzuf√ºgen - <span id="quickAddDate"></span></h2>
            
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 14px; color: #666; margin-bottom: 12px;"><strong>Quick Buttons:</strong></label>
                <div class="quick-buttons">
                    <button type="button" class="btn-secondary" onclick="submitQuickAddTrip(3.60, 'S-Bahn Sbg')">
                        üöá S-Bahn Sbg<br>(3,60‚Ç¨)
                    </button>
                    <button type="button" class="btn-secondary" onclick="submitQuickAddTrip(3.00, 'Obus Sbg')">
                        üöå Obus Sbg<br>(3,00‚Ç¨)
                    </button>
                </div>
            </div>

            <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--border);">

            <form class="settings-form" onsubmit="submitCustomQuickAddTrip(event)">
                <label for="quickTripRoute">Route (optional):</label>
                <input type="text" id="quickTripRoute" placeholder="z.B. Salzburg - Wien">

                <label for="quickTripBundeslaender" style="margin-top: 12px;">Bundesland(er):</label>
                <select id="quickTripBundeslaender" multiple style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                    <option value="Salzburg" selected>Salzburg</option>
                    <option value="Wien">Wien</option>
                    <option value="Nieder√∂sterreich">Nieder√∂sterreich</option>
                    <option value="Ober√∂sterreich">Ober√∂sterreich</option>
                    <option value="Tirol">Tirol</option>
                    <option value="Vorarlberg">Vorarlberg</option>
                    <option value="Steiermark">Steiermark</option>
                    <option value="Burgenland">Burgenland</option>
                    <option value="K√§rnten">K√§rnten</option>
                </select>
                
                <label for="quickTripCost" style="margin-top: 12px;">Kosten (EUR):</label>
                <input type="number" id="quickTripCost" placeholder="5.00" step="0.01" min="0" required>
                
                <label for="quickTripNotes" style="margin-top: 12px;">Notiz (optional):</label>
                <input type="text" id="quickTripNotes" placeholder="optional">
                
                <div class="modal-buttons" style="margin-top: 20px;">
                    <button type="button" class="modal-btn-secondary" onclick="closeQuickAddModal()">Abbrechen</button>
                    <button type="submit" class="modal-btn-primary">Hinzuf√ºgen</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const DEFAULT_TICKET_COST = 1400;
        const DEFAULT_START_DATE = new Date(2025, 0, 23);
        const DEFAULT_END_DATE = new Date(2026, 0, 22);
        const SUPABASE_URL = 'https://qfkfcirfwlfjscevxilu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_REFOWIFpP1IbO5rEARlXUA_Z5Qw--d0';

        let supabase = null;
        let currentUser = null;
        let userTicketCost = DEFAULT_TICKET_COST; // Dynamic per user
        let userStartDate = DEFAULT_START_DATE; // Dynamic per user
        let userEndDate = DEFAULT_END_DATE; // Dynamic per user
        let showOnlyNoBundesland = false; // Filter for trips without Bundesland
        let allTripsForHeatmap = []; // Store all trips for heatmap navigation
        let currentHeatmapDate = new Date(); // Current month being displayed

        // Initialize Supabase
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (err) {
            console.error('Supabase initialization failed:', err);
            showToast('‚ö†Ô∏è Cloud-Verbindung konnte nicht hergestellt werden', 'error');
        }

        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('tripDate').value = today;

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => 
                console.log('Service Worker registration failed:', err)
            );
        }

        // Reload data function
        async function reloadData() {
            const reloadBtn = document.getElementById('reloadBtn');
            reloadBtn.style.opacity = '0.5';
            reloadBtn.style.transform = 'rotate(180deg)';
            reloadBtn.style.transition = 'transform 0.6s ease';
            
            try {
                await loadData();
                showToast('‚úÖ Daten aktualisiert!', 'success');
            } catch (err) {
                console.error('Reload error:', err);
                showToast('‚ùå Fehler beim Aktualisieren', 'error');
            } finally {
                setTimeout(() => {
                    reloadBtn.style.opacity = '1';
                    reloadBtn.style.transform = 'rotate(0deg)';
                }, 600);
            }
        }

        // Pull-to-refresh functionality
        let touchStartY = 0;
        let isRefreshing = false;

        document.addEventListener('touchstart', (e) => {
            if (window.scrollY === 0) {
                touchStartY = e.touches[0].clientY;
            }
        }, false);

        document.addEventListener('touchmove', (e) => {
            if (isRefreshing || window.scrollY !== 0) return;
            
            const touchY = e.touches[0].clientY;
            const diff = touchY - touchStartY;

            if (diff > 100 && !isRefreshing) {
                isRefreshing = true;
                reloadData();
                setTimeout(() => {
                    isRefreshing = false;
                }, 2000);
            }
        }, false);

        // Check authentication status on page load
        async function checkAuth() {
            try {
                // Handle email confirmation from sign-up link
                await handleEmailConfirmation();
                
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
                updateAuthUI();
                loadData();
            } catch (err) {
                console.error('Auth check failed:', err);
                updateAuthUI();
                loadData();
            }
        }

        // Handle email confirmation from sign-up link
        async function handleEmailConfirmation() {
            const params = new URLSearchParams(window.location.search);
            const tokenHash = params.get('token_hash');
            const type = params.get('type');

            if (tokenHash && type === 'email_signup') {
                try {
                    showToast('‚è≥ E-Mail wird best√§tigt...', 'success');
                    const { error } = await supabase.auth.verifyOtp({
                        token_hash: tokenHash,
                        type: 'email'
                    });

                    if (error) throw error;

                    // Clear URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    showToast('‚úÖ E-Mail best√§tigt! Du bist jetzt angemeldet.', 'success');
                } catch (err) {
                    console.error('Email confirmation error:', err);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    showToast('‚ùå E-Mail-Best√§tigung fehlgeschlagen: ' + err.message, 'error');
                }
            }
        }

        // Show/close auth modal
        function openAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            // Clear form fields
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('signupEmail').value = '';
            document.getElementById('signupPassword').value = '';
            document.getElementById('signupPasswordConfirm').value = '';
        }

        function switchAuthTab(tab) {
            // Update tabs
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update forms
            document.querySelectorAll('.modal-form').forEach(f => f.classList.remove('active'));
            if (tab === 'login') {
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.getElementById('signupForm').classList.add('active');
            }
        }

        // Submit login form
        async function submitLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            try {
                showToast('‚è≥ Anmelden l√§uft...', 'success');
                const { error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                if (error) throw error;
                showToast('‚úÖ Erfolgreich angemeldet!', 'success');
                closeAuthModal();
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
                updateAuthUI();
                loadData();
            } catch (err) {
                console.error('Login error:', err);
                showToast('‚ùå ' + (err.message || 'Login fehlgeschlagen'), 'error');
            }
        }

        // Submit signup form
        async function submitSignup(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

            if (password !== passwordConfirm) {
                showToast('‚ùå Passw√∂rter stimmen nicht √ºberein', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('‚ùå Passwort muss mindestens 6 Zeichen lang sein', 'error');
                return;
            }

            try {
                showToast('‚è≥ Account wird erstellt...', 'success');
                const { error } = await supabase.auth.signUp({
                    email,
                    password
                });
                if (error) throw error;
                showToast('‚úÖ Account erfolgreich erstellt! Du bist jetzt angemeldet.', 'success');
                closeAuthModal();
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
                updateAuthUI();
                loadData();
            } catch (err) {
                console.error('Signup error:', err);
                showToast('‚ùå ' + (err.message || 'Registrierung fehlgeschlagen'), 'error');
            }
        }

        // Handle authentication button click
        async function handleAuth() {
            openAuthModal();
        }

        // Handle profile button toggle (login/logout)
        async function handleAuthToggle() {
            if (currentUser) {
                await logout();
            } else {
                openAuthModal();
            }
        }

        // Logout
        async function logout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                userTicketCost = DEFAULT_TICKET_COST;
                updateAuthUI();
                showToast('üëã Abgemeldet', 'success');
            } catch (err) {
                console.error('Logout error:', err);
            }
        }

        // Settings Modal functions
        function openSettingsModal() {
            document.getElementById('ticketCostInput').value = userTicketCost;
            document.getElementById('startDateInput').value = userStartDate.toISOString().split('T')[0];
            document.getElementById('endDateInput').value = userEndDate.toISOString().split('T')[0];
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        async function submitSettings(e) {
            e.preventDefault();
            const ticketCost = document.getElementById('ticketCostInput').value;
            const startDate = document.getElementById('startDateInput').value;
            const endDate = document.getElementById('endDateInput').value;

            if (!ticketCost || isNaN(ticketCost) || parseFloat(ticketCost) < 0) {
                showToast('‚ùå Bitte gib einen g√ºltigen Betrag ein', 'error');
                return;
            }

            if (!startDate || !endDate) {
                showToast('‚ùå Bitte gib Start- und Enddatum ein', 'error');
                return;
            }

            if (new Date(startDate) >= new Date(endDate)) {
                showToast('‚ùå Anfangsdatum muss vor dem Enddatum liegen', 'error');
                return;
            }

            await saveUserSettings(ticketCost, startDate, endDate);
            closeSettingsModal();
            showToast('‚úÖ Einstellungen gespeichert!', 'success');
        }

        // Update auth UI
        function updateAuthUI() {
            const profileBtn = document.getElementById('profileBtn');
            const authBtn = document.getElementById('authBtn');
            const settingsBtn = document.getElementById('settingsBtn');

            if (currentUser) {
                profileBtn.classList.remove('hidden');
                authBtn.classList.add('hidden');
                settingsBtn.classList.remove('hidden');
            } else {
                profileBtn.classList.add('hidden');
                authBtn.classList.remove('hidden');
                settingsBtn.classList.add('hidden');
            }
        }

        // Toggle filter for trips without Bundesland
        function toggleNoBundeslandFilter() {
            showOnlyNoBundesland = !showOnlyNoBundesland;
            const btn = document.getElementById('filterNoBundeslandBtn');
            if (showOnlyNoBundesland) {
                btn.style.background = '#4caf50';
                btn.style.color = 'white';
                btn.textContent = '‚úì Ohne Bundesland';
            } else {
                btn.style.background = '';
                btn.style.color = '';
                btn.textContent = 'üîç Ohne Bundesland';
            }
            loadData();
        }

        // Load data from Supabase or localStorage
        async function loadData() {
            try {
                // Load user settings first
                if (currentUser) {
                    await loadUserSettings();
                }

                let trips = [];
                
                if (currentUser) {
                    // Load from Supabase
                    const { data, error } = await supabase
                        .from('trips')
                        .select('*')
                        .order('date', { ascending: false });
                    
                    if (error) throw error;
                    trips = data || [];
                } else {
                    // Load from localStorage
                    trips = getLocalTrips();
                }

                displayTrips(trips);
                updateStats(trips);
                updateDaysRemaining();
            } catch (err) {
                console.error('Load error:', err);
                // Fallback to localStorage
                const trips = getLocalTrips();
                displayTrips(trips);
                updateStats(trips);
            }
        }

        // Load user settings from Supabase
        async function loadUserSettings() {
            try {
                const { data, error } = await supabase
                    .from('user_settings')
                    .select('ticket_cost, start_date, end_date')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();
                
                if (data) {
                    userTicketCost = data.ticket_cost;
                    userStartDate = new Date(data.start_date);
                    userEndDate = new Date(data.end_date);
                } else if (!error) {
                    // No data but no error - create initial settings
                    await saveUserSettings(DEFAULT_TICKET_COST, DEFAULT_START_DATE, DEFAULT_END_DATE);
                    userTicketCost = DEFAULT_TICKET_COST;
                    userStartDate = DEFAULT_START_DATE;
                    userEndDate = DEFAULT_END_DATE;
                } else {
                    // Error occurred - use defaults and try localStorage
                    const localSettings = localStorage.getItem('user_settings');
                    if (localSettings) {
                        const settings = JSON.parse(localSettings);
                        userTicketCost = settings.ticket_cost || DEFAULT_TICKET_COST;
                        userStartDate = new Date(settings.start_date || DEFAULT_START_DATE);
                        userEndDate = new Date(settings.end_date || DEFAULT_END_DATE);
                    } else {
                        userTicketCost = DEFAULT_TICKET_COST;
                        userStartDate = DEFAULT_START_DATE;
                        userEndDate = DEFAULT_END_DATE;
                    }
                }
            } catch (err) {
                console.error('Load settings error:', err);
                // Fallback to localStorage
                const localSettings = localStorage.getItem('user_settings');
                if (localSettings) {
                    const settings = JSON.parse(localSettings);
                    userTicketCost = settings.ticket_cost || DEFAULT_TICKET_COST;
                    userStartDate = new Date(settings.start_date || DEFAULT_START_DATE);
                    userEndDate = new Date(settings.end_date || DEFAULT_END_DATE);
                } else {
                    userTicketCost = DEFAULT_TICKET_COST;
                    userStartDate = DEFAULT_START_DATE;
                    userEndDate = DEFAULT_END_DATE;
                }
            }
        }

        // Save user settings to Supabase
        async function saveUserSettings(ticketCost, startDate, endDate) {
            if (!currentUser) return;
            
            try {
                const { error } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: currentUser.id,
                        ticket_cost: parseFloat(ticketCost),
                        start_date: startDate instanceof Date ? startDate.toISOString().split('T')[0] : startDate,
                        end_date: endDate instanceof Date ? endDate.toISOString().split('T')[0] : endDate,
                        updated_at: new Date().toISOString()
                    });
                
                if (error) {
                    console.error('Supabase error details:', error);
                    throw error;
                }
                userTicketCost = parseFloat(ticketCost);
                userStartDate = startDate instanceof Date ? startDate : new Date(startDate);
                userEndDate = endDate instanceof Date ? endDate : new Date(endDate);
                await loadData(); // Reload with new settings
            } catch (err) {
                console.error('Save settings error:', err);
                // Fallback to localStorage for offline support
                const settingsData = {
                    ticket_cost: parseFloat(ticketCost),
                    start_date: startDate instanceof Date ? startDate.toISOString().split('T')[0] : startDate,
                    end_date: endDate instanceof Date ? endDate.toISOString().split('T')[0] : endDate
                };
                localStorage.setItem('user_settings', JSON.stringify(settingsData));
                userTicketCost = parseFloat(ticketCost);
                userStartDate = startDate instanceof Date ? startDate : new Date(startDate);
                userEndDate = endDate instanceof Date ? endDate : new Date(endDate);
                showToast('‚ö†Ô∏è Einstellungen lokal gespeichert (kein Cloud-Zugriff)', 'success');
            }
        }

        function getLocalTrips() {
            const data = localStorage.getItem('trips');
            return data ? JSON.parse(data) : [];
        }

        // Add trip
        async function addTrip() {
            const date = document.getElementById('tripDate').value;
            const route = document.getElementById('tripRoute').value.trim();
            const cost = parseFloat(document.getElementById('tripCost').value);
            const notes = document.getElementById('tripNotes').value.trim();
            
            // Get selected Bundesl√§nder
            const bundeslaenderSelect = document.getElementById('tripBundeslaender');
            const bundeslaender = Array.from(bundeslaenderSelect.selectedOptions).map(opt => opt.value);

            if (!date || !route || !cost || cost <= 0) {
                showToast('‚ùå Bitte alle Felder ausf√ºllen!', 'error');
                return;
            }

            const trip = {
                date,
                route,
                cost: parseFloat(cost.toFixed(2)),
                notes,
                bundeslaender: bundeslaender.length > 0 ? bundeslaender : ['Salzburg']
            };

            try {
                if (currentUser) {
                    // Save to Supabase
                    const { error } = await supabase
                        .from('trips')
                        .insert([trip]);
                    
                    if (error) throw error;
                } else {
                    // Save to localStorage
                    const trips = getLocalTrips();
                    trips.push({ ...trip, id: Date.now(), timestamp: new Date().toISOString() });
                    localStorage.setItem('trips', JSON.stringify(trips));
                }

                showToast(`‚úÖ Fahrt "${route}" (+‚Ç¨${cost.toFixed(2)}) hinzugef√ºgt!`);

                // Clear form
                document.getElementById('tripRoute').value = '';
                document.getElementById('tripCost').value = '';
                document.getElementById('tripNotes').value = '';
                document.getElementById('tripDate').value = today;

                loadData();

                // Scroll to trips list
                setTimeout(() => {
                    document.getElementById('tripsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            } catch (err) {
                console.error('Add trip error:', err);
                showToast('‚ùå Fehler beim Speichern: ' + err.message, 'error');
            }
        }

        // Add quick trip
        async function addQuickTrip(cost, route) {
            const trip = {
                date: today,
                route,
                cost,
                bundeslaender: ['Salzburg']
            };

            try {
                if (currentUser) {
                    const { error } = await supabase
                        .from('trips')
                        .insert([trip]);
                    
                    if (error) throw error;
                } else {
                    const trips = getLocalTrips();
                    trips.push({ ...trip, id: Date.now(), notes: '', timestamp: new Date().toISOString() });
                    localStorage.setItem('trips', JSON.stringify(trips));
                }

                showToast(`‚úÖ ${route} (+‚Ç¨${cost.toFixed(2)}) hinzugef√ºgt!`);
                loadData();

                setTimeout(() => {
                    document.getElementById('tripsList').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            } catch (err) {
                console.error('Quick trip error:', err);
                showToast('‚ùå Fehler: ' + err.message, 'error');
            }
        }

        // Open quick add modal from calendar click
        function openQuickAddFromCalendar(dateStr) {
            document.getElementById('quickAddDate').textContent = formatDate(dateStr);
            document.getElementById('quickTripRoute').value = '';
            document.getElementById('quickTripCost').value = '';
            document.getElementById('quickTripNotes').value = '';
            document.getElementById('quickAddModal').classList.add('active');
            document.getElementById('quickAddModal').dataset.selectedDate = dateStr;
        }

        function closeQuickAddModal() {
            document.getElementById('quickAddModal').classList.remove('active');
        }

        // Quick add trip with selected date
        async function submitQuickAddTrip(cost, route) {
            const dateStr = document.getElementById('quickAddModal').dataset.selectedDate;
            const notes = document.getElementById('quickTripNotes').value.trim();

            const trip = {
                date: dateStr,
                route,
                cost,
                notes,
                bundeslaender: ['Salzburg']
            };

            try {
                if (currentUser) {
                    const { error } = await supabase
                        .from('trips')
                        .insert([trip]);
                    
                    if (error) throw error;
                } else {
                    const trips = getLocalTrips();
                    trips.push({ ...trip, id: Date.now(), timestamp: new Date().toISOString() });
                    localStorage.setItem('trips', JSON.stringify(trips));
                }

                showToast(`‚úÖ ${route} (+‚Ç¨${cost.toFixed(2)}) am ${formatDate(dateStr)} hinzugef√ºgt!`);
                closeQuickAddModal();
                loadData();
            } catch (err) {
                console.error('Quick add error:', err);
                showToast('‚ùå Fehler: ' + err.message, 'error');
            }
        }

        // Custom quick add trip
        async function submitCustomQuickAddTrip(event) {
            event.preventDefault();
            const dateStr = document.getElementById('quickAddModal').dataset.selectedDate;
            const route = document.getElementById('quickTripRoute').value.trim() || 'Fahrt';
            const cost = parseFloat(document.getElementById('quickTripCost').value);
            const notes = document.getElementById('quickTripNotes').value.trim();
            
            // Get selected Bundesl√§nder (defaults to Salzburg if none selected)
            const bundeslaenderSelect = document.getElementById('quickTripBundeslaender');
            const bundeslaender = Array.from(bundeslaenderSelect.selectedOptions).map(opt => opt.value);

            if (!cost || cost <= 0) {
                showToast('‚ùå Bitte Kosten eingeben!', 'error');
                return;
            }

            const trip = {
                date: dateStr,
                route,
                cost,
                notes,
                bundeslaender: bundeslaender.length > 0 ? bundeslaender : ['Salzburg']
            };

            try {
                if (currentUser) {
                    const { error } = await supabase
                        .from('trips')
                        .insert([trip]);
                    
                    if (error) throw error;
                } else {
                    const trips = getLocalTrips();
                    trips.push({ ...trip, id: Date.now(), timestamp: new Date().toISOString() });
                    localStorage.setItem('trips', JSON.stringify(trips));
                }

                showToast(`‚úÖ ${route} (+‚Ç¨${cost.toFixed(2)}) am ${formatDate(dateStr)} hinzugef√ºgt!`);
                closeQuickAddModal();
                loadData();
            } catch (err) {
                console.error('Custom quick add error:', err);
                showToast('‚ùå Fehler: ' + err.message, 'error');
            }
        }

        // Delete trip
        async function deleteTrip(id) {
            if (!confirm('Fahrt wirklich l√∂schen?')) return;

            try {
                if (currentUser) {
                    const { error } = await supabase
                        .from('trips')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                } else {
                    const trips = getLocalTrips();
                    const filtered = trips.filter(t => t.id !== id);
                    localStorage.setItem('trips', JSON.stringify(filtered));
                }

                loadData();
            } catch (err) {
                console.error('Delete error:', err);
                showToast('‚ùå Fehler beim L√∂schen: ' + err.message, 'error');
            }
        }

        // Store current trip being edited
        let currentEditTrip = null;

        // Edit trip
        async function editTrip(id) {
            let trip = null;

            if (currentUser) {
                const { data, error } = await supabase
                    .from('trips')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) {
                    showToast('‚ùå Fehler beim Laden der Fahrt', 'error');
                    return;
                }
                trip = data;
            } else {
                const trips = getLocalTrips();
                trip = trips.find(t => t.id === id);
                if (!trip) {
                    showToast('‚ùå Fahrt nicht gefunden', 'error');
                    return;
                }
            }

            currentEditTrip = trip;
            document.getElementById('editTripDate').value = trip.date;
            document.getElementById('editTripRoute').value = trip.route;
            document.getElementById('editTripCost').value = trip.cost;
            document.getElementById('editTripNotes').value = trip.notes || '';
            
            // Load Bundesl√§nder
            const bundeslaenderSelect = document.getElementById('editTripBundeslaender');
            bundeslaenderSelect.value = '';
            if (trip.bundeslaender && Array.isArray(trip.bundeslaender)) {
                Array.from(bundeslaenderSelect.options).forEach(option => {
                    option.selected = trip.bundeslaender.includes(option.value);
                });
            } else {
                // Default to Salzburg if no bundeslaender
                document.querySelector('#editTripBundeslaender option[value="Salzburg"]').selected = true;
            }
            
            document.getElementById('editTripModal').classList.add('active');
        }

        function closeEditTripModal() {
            document.getElementById('editTripModal').classList.remove('active');
            currentEditTrip = null;
        }

        // Submit edit trip
        async function submitEditTrip(e) {
            e.preventDefault();

            if (!currentEditTrip) return;

            const date = document.getElementById('editTripDate').value;
            const route = document.getElementById('editTripRoute').value.trim();
            const cost = parseFloat(document.getElementById('editTripCost').value);
            const notes = document.getElementById('editTripNotes').value.trim();
            
            // Get selected Bundesl√§nder
            const bundeslaenderSelect = document.getElementById('editTripBundeslaender');
            const bundeslaender = Array.from(bundeslaenderSelect.selectedOptions).map(opt => opt.value);

            if (!date || !route || !cost || cost <= 0) {
                showToast('‚ùå Bitte alle Felder ausf√ºllen!', 'error');
                return;
            }

            try {
                if (currentUser) {
                    const { error } = await supabase
                        .from('trips')
                        .update({
                            date,
                            route,
                            cost: parseFloat(cost.toFixed(2)),
                            notes,
                            bundeslaender: bundeslaender.length > 0 ? bundeslaender : ['Salzburg']
                        })
                        .eq('id', currentEditTrip.id);
                    
                    if (error) throw error;
                } else {
                    const trips = getLocalTrips();
                    const index = trips.findIndex(t => t.id === currentEditTrip.id);
                    if (index !== -1) {
                        trips[index] = {
                            ...trips[index],
                            date,
                            route,
                            cost: parseFloat(cost.toFixed(2)),
                            notes,
                            bundeslaender: bundeslaender.length > 0 ? bundeslaender : ['Salzburg']
                        };
                        localStorage.setItem('trips', JSON.stringify(trips));
                    }
                }

                showToast(`‚úÖ Fahrt "${route}" aktualisiert!`);
                closeEditTripModal();
                loadData();
            } catch (err) {
                console.error('Edit trip error:', err);
                showToast('‚ùå Fehler beim Speichern: ' + err.message, 'error');
            }
        }

        // Display trips
        // Check if trip is within validity range
        function isValidTrip(trip) {
            const tripDate = new Date(trip.date + 'T00:00:00');
            return tripDate >= userStartDate && tripDate <= userEndDate;
        }

        function displayTrips(trips) {
            const tripsList = document.getElementById('tripsList');
            
            if (trips.length === 0) {
                tripsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Noch keine Fahrten hinzugef√ºgt</p>';
                return;
            }

            // Filter trips if needed
            let filtered = trips;
            if (showOnlyNoBundesland) {
                filtered = trips.filter(trip => !trip.bundeslaender || trip.bundeslaender.length === 0);
                if (filtered.length === 0) {
                    tripsList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">‚úì Alle Fahrten haben ein Bundesland!</p>';
                    return;
                }
            }

            const sorted = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));

            tripsList.innerHTML = sorted.map(trip => {
                const valid = isValidTrip(trip);
                const badge = valid ? '' : '<span style="display: inline-block; background: #f44336; color: white; font-size: 10px; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">‚ö†Ô∏è Au√üerhalb</span>';
                
                // Format Bundesl√§nder
                let bundeslaenderText = '';
                if (trip.bundeslaender && Array.isArray(trip.bundeslaender) && trip.bundeslaender.length > 0) {
                    bundeslaenderText = `<div style="font-size: 11px; color: #888; margin-top: 3px;">üìç ${trip.bundeslaender.join(', ')}</div>`;
                }
                
                return `
                <div class="trip-item" style="${valid ? '' : 'opacity: 0.6; background: #fff5f5;'}">
                    <div class="trip-info">
                        <div class="trip-date">${formatDate(trip.date)}${badge}</div>
                        <div><strong>${trip.route}</strong></div>
                        ${trip.notes ? `<div style="font-size: 12px; color: #666;">${trip.notes}</div>` : ''}
                        ${bundeslaenderText}
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="trip-cost">‚Ç¨${trip.cost.toFixed(2)}</div>
                        <button class="trip-delete" style="background: var(--secondary); padding: 6px 10px;" onclick="editTrip(${trip.id})">‚úèÔ∏è</button>
                        <button class="trip-delete" onclick="deleteTrip(${trip.id})">‚úï</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Update stats
        function updateStats(trips) {
            // Filter only valid trips (within validity range)
            const validTrips = trips.filter(trip => isValidTrip(trip));
            const totalCost = validTrips.reduce((sum, trip) => sum + trip.cost, 0);
            const savings = totalCost - userTicketCost;
            const progressPercent = Math.min(100, (totalCost / userTicketCost) * 100);

            document.getElementById('tripCount').textContent = validTrips.length;
            document.getElementById('totalCost').textContent = '‚Ç¨' + totalCost.toFixed(2);
            document.getElementById('savings').textContent = '‚Ç¨' + Math.abs(savings).toFixed(2);
            document.getElementById('progressFill').style.width = progressPercent + '%';

            // Update label based on savings status
            const savingsLabel = document.getElementById('savingsLabel');
            if (savings >= 0) {
                savingsLabel.textContent = 'Ersparnis mit Klimaticket';
            } else {
                savingsLabel.textContent = 'Noch ben√∂tigte Fahrkosten';
            }

            const messageEl = document.getElementById('message');
            if (validTrips.length === 0) {
                messageEl.classList.add('hidden');
            } else if (savings >= 0) {
                messageEl.className = 'message positive';
                messageEl.textContent = `‚úÖ Gl√ºckwunsch! Du sparst ${Math.abs(savings).toFixed(2)}‚Ç¨ mit dem Klimaticket.`;
            } else {
                messageEl.className = 'message negative';
                messageEl.textContent = `‚ö†Ô∏è Du brauchst noch ‚Ç¨${Math.abs(savings).toFixed(2)} an Fahrten, um das Ticket auszugleichen.`;
            }

            // Generate heatmap
            generateHeatmap(validTrips);
            
            // Generate Bundeslands heatmap
            generateBundeslandsHeatmap(validTrips);
        }

        // Update days remaining
        function updateDaysRemaining() {
            const now = new Date();
            const daysLeft = Math.max(0, Math.ceil((userEndDate - now) / (1000 * 60 * 60 * 24)));
            document.getElementById('daysRemaining').textContent = daysLeft + ' Tage';
            
            // Update expiry date display
            const expiryOptions = { day: '2-digit', month: 'short', year: 'numeric' };
            document.getElementById('expiryDate').textContent = userEndDate.toLocaleDateString('de-AT', expiryOptions);
        }

        // Format date
        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const options = { day: '2-digit', month: 'short', year: 'numeric' };
            return date.toLocaleDateString('de-AT', options);
        }

        // Generate heatmap for single month
        function generateHeatmap(trips) {
            allTripsForHeatmap = trips; // Store for navigation
            renderHeatmapMonth();
        }
        
        // Generate Bundeslands heatmap
        function generateBundeslandsHeatmap(trips) {
            const bundeslaender = [
                'Burgenland', 'K√§rnten', 'Nieder√∂sterreich', 
                'Ober√∂sterreich', 'Salzburg', 'Steiermark', 
                'Tirol', 'Vorarlberg', 'Wien'
            ];
            
            // Count trips per Bundesland
            const countsByBundesland = {};
            bundeslaender.forEach(bl => countsByBundesland[bl] = 0);
            
            trips.forEach(trip => {
                if (trip.bundeslaender && Array.isArray(trip.bundeslaender)) {
                    trip.bundeslaender.forEach(bl => {
                        if (countsByBundesland[bl] !== undefined) {
                            countsByBundesland[bl]++;
                        }
                    });
                }
            });
            
            // Find max count for scaling
            const maxCount = Math.max(...Object.values(countsByBundesland), 1);
            
            // Update SVG map colors
            bundeslaender.forEach(bl => {
                const count = countsByBundesland[bl];
                const level = maxCount === 0 ? 0 : Math.ceil((count / maxCount) * 4);
                const colors = ['#e8f5e9', '#c8e6c9', '#81c784', '#4caf50', '#2e7d32'];
                const color = colors[level];
                
                const element = document.getElementById(bl.toLowerCase());
                if (element) {
                    element.setAttribute('fill', color);
                }
            });
            
            // Update stats list
            const bundeslandsStats = document.getElementById('bundeslandsStats');
            bundeslandsStats.innerHTML = bundeslaender
                .sort((a, b) => countsByBundesland[b] - countsByBundesland[a])
                .map(bl => {
                    const count = countsByBundesland[bl];
                    return `<div style="padding: 8px; background: #f8f9fa; border-radius: 4px; text-align: center;">
                        <div style="font-weight: 600; color: var(--dark);">${count}</div>
                        <div style="color: #666; font-size: 11px;">${bl}</div>
                    </div>`;
                })
                .join('');
        }

        // Render current month heatmap
        function renderHeatmapMonth() {
            const heatmapContent = document.getElementById('heatmapContent');
            const heatmapMonthTitle = document.getElementById('heatmapMonthTitle');
            
            // Count trips by date
            const tripsByDate = {};
            allTripsForHeatmap.forEach(trip => {
                tripsByDate[trip.date] = (tripsByDate[trip.date] || 0) + 1;
            });

            if (Object.keys(tripsByDate).length === 0) {
                heatmapContent.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #999; padding: 20px;">Noch keine Fahrten zum Visualisieren</p>';
                return;
            }

            const year = currentHeatmapDate.getFullYear();
            const month = currentHeatmapDate.getMonth();
            const monthName = currentHeatmapDate.toLocaleDateString('de-AT', { month: 'long', year: 'numeric' });
            heatmapMonthTitle.textContent = monthName;

            // Get all days in month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            // Create day cells
            let dayHeaders = '';
            const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            for (let i = 0; i < 7; i++) {
                dayHeaders += `<div class="heatmap-day-header">${dayNames[i]}</div>`;
            }

            let dayCells = dayHeaders;

            // Empty cells before first day
            for (let i = 0; i < startingDayOfWeek; i++) {
                dayCells += '<div class="heatmap-day empty"></div>';
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const count = tripsByDate[dateStr] || 0;
                let level = 'empty';
                
                if (count >= 4) level = 'level-4';
                else if (count >= 3) level = 'level-3';
                else if (count >= 2) level = 'level-2';
                else if (count >= 1) level = 'level-1';

                // Check if this is today
                const isToday = dateStr === today;
                const todayStyle = isToday ? 'border: 2px solid #ff5722; box-shadow: 0 0 8px rgba(255, 87, 34, 0.5); font-weight: bold;' : '';

                const title = count > 0 ? `${count} Fahrt${count !== 1 ? 'en' : ''}` : 'Keine Fahrten';
                dayCells += `<div class="heatmap-day ${level}" title="${title}" style="cursor: pointer; ${todayStyle}" onclick="openQuickAddFromCalendar('${dateStr}')">${day}</div>`;
            }

            heatmapContent.innerHTML = `
                <div class="heatmap-month">
                    <div class="heatmap-days">${dayCells}</div>
                </div>
            `;
        }

        // Navigate heatmap months
        function previousHeatmapMonth() {
            currentHeatmapDate.setMonth(currentHeatmapDate.getMonth() - 1);
            renderHeatmapMonth();
        }

        function nextHeatmapMonth() {
            currentHeatmapDate.setMonth(currentHeatmapDate.getMonth() + 1);
            renderHeatmapMonth();
        }

        // Export functions
        async function exportJSON() {
            try {
                let trips = [];
                if (currentUser) {
                    const { data, error } = await supabase.from('trips').select('*');
                    if (error) throw error;
                    trips = data || [];
                } else {
                    trips = getLocalTrips();
                }

                const dataStr = JSON.stringify(trips, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                downloadFile(dataBlob, 'klimaticket-daten.json');
            } catch (err) {
                showToast('‚ùå Export fehler: ' + err.message, 'error');
            }
        }

        async function exportCSV() {
            try {
                let trips = [];
                if (currentUser) {
                    const { data, error } = await supabase.from('trips').select('*');
                    if (error) throw error;
                    trips = data || [];
                } else {
                    trips = getLocalTrips();
                }

                const headers = ['Datum', 'Route', 'Kosten (EUR)', 'Notiz'];
                const rows = trips.map(t => [t.date, t.route, t.cost, t.notes || '']);

                let csv = headers.join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(cell => `"${cell}"`).join(',') + '\n';
                });

                const dataBlob = new Blob([csv], { type: 'text/csv' });
                downloadFile(dataBlob, 'klimaticket-daten.csv');
            } catch (err) {
                showToast('‚ùå Export fehler: ' + err.message, 'error');
            }
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleFileImport() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    let trips = [];
                    if (file.name.endsWith('.json')) {
                        trips = JSON.parse(e.target.result);
                    } else if (file.name.endsWith('.csv')) {
                        const lines = e.target.result.split('\n').slice(1);
                        trips = lines.map(line => {
                            const parts = line.split(',').map(p => p.replace(/^"|"$/g, ''));
                            return {
                                date: parts[0],
                                route: parts[1],
                                cost: parseFloat(parts[2]) || 0,
                                notes: parts[3] || ''
                            };
                        }).filter(t => t.date && t.route && t.cost > 0);
                    }

                    if (trips.length > 0) {
                        if (currentUser) {
                            const { error } = await supabase.from('trips').insert(trips);
                            if (error) throw error;
                        } else {
                            const localTrips = getLocalTrips();
                            localTrips.push(...trips.map(t => ({
                                ...t,
                                id: Date.now() + Math.random(),
                                timestamp: new Date().toISOString()
                            })));
                            localStorage.setItem('trips', JSON.stringify(localTrips));
                        }

                        loadData();
                        showToast(`‚úÖ ${trips.length} Fahrten importiert!`);
                    }
                } catch (err) {
                    showToast('‚ùå Import fehler: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            document.getElementById('importFile').value = '';
        }

        async function clearAllData() {
            if (!confirm('Alle Daten wirklich l√∂schen?')) return;

            try {
                if (currentUser) {
                    const { error } = await supabase.from('trips').delete().neq('id', 0);
                    if (error) throw error;
                } else {
                    localStorage.removeItem('trips');
                }

                loadData();
                showToast('üóëÔ∏è Alle Daten gel√∂scht!', 'error');
            } catch (err) {
                showToast('‚ùå Fehler: ' + err.message, 'error');
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Initial load
        checkAuth();
    </script>
</body>
</html>
